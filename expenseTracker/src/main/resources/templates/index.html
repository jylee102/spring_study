<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<th:block layout:fragment="css">
  <style>
    .floating-button {
      position: fixed;
      bottom: 50px;
      right: 50px;
    }

    .floating-button > button {
      width: 70px !important;
      height: 70px !important;
    }

    .floating-button > button > i {
      font-size: xx-large;
    }

    .modal-content {
      background: white;
      color: black;
    }

    #dtlModal select, #dtlModal input, #dtlModal textarea {
      border: 1px solid black;
      color: black;
    }
  </style>
</th:block>

<head>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
  <div layout:fragment="content" class="row">
    <div class="col-lg-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">내역</h4>
          <p class="card-description"> Add class <code>.table-dark</code>
          </p>
          <form th:action="@{'/' + ${items.number}}" method="get"
                th:object="${items}" class="table-responsive">
            <table class="table table-hover table-striped">
              <thead>
              <tr>
                <th> 날짜 </th>
                <th> 자산 </th>
                <th> 분류 </th>
                <th> 내용 </th>
                <th> 금액 </th>
              </tr>
              </thead>
              <tbody class="table-group-divider">
              </tbody>
            </table>
          </form>

          <nav aria-label="Page navigation example"
               th:with="start=${(items.number/maxPage) * maxPage + 1},
               end=(${(items.totalPages == 0) ? 1 : (start + (maxPage - 1) < items.totalPages ? start + (maxPage - 1) : items.totalPages)})">
            <ul class="pagination d-flex justify-content-center">
              <li class="page-item" th:classappend="${items.first} ? 'disabled'">
                <a class="page-link"
                   th:href="'/' + ${items.number - 1}">이전</a>
              </li>

              <li class="page-item"
                  th:each="page : ${#numbers.sequence(start, end)}"
                  th:classappend="${items.number eq page-1} ? 'active' : ''">
                <a class="page-link" th:inline="text"
                   th:href="'/' + ${page - 1}">[[${page}]]</a>
              </li>

              <li class="page-item" th:classappend="${items.last} ? 'disabled'">
                <a class="page-link"
                   th:href="'/' + ${items.number + 1}">다음</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <div class="floating-button">
      <button type="button" onclick="$('#date').val(getTodayDate()); $('#insertModal').modal('show');"
              class="btn btn-dribbble btn-rounded btn-icon">
        <i class="mdi mdi-plus"></i>
      </button>
    </div>

    <!-- Modal -->
    <div id="dtlModal" class="modal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" action="/transaction/delete" method="post" name="deleteForm">
          <div class="modal-header">
            <h5 class="modal-title">상세 정보</h5>
            <button type="button" style="border: none;" class="btn-close"
                    onclick="$('#dtlModal').modal('hide')" aria-label="Close">
              <i class="mdi mdi-window-close"></i>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" class="displayId" />
            <div class="form-group dataTables_wrapper">
              <label>유형:</label>
              <select class="form-select displayType" disabled>
                <option value="income">수입</option>
                <option value="expense">지출</option>
              </select>
            </div>
            <div class="form-group">
              <label>날짜:</label>
              <input type="date" class="form-control displayDate" readonly="readonly">
            </div>
            <div class="form-group dataTables_wrapper">
              <label>자산:</label>
              <select class="form-select displayAsset" disabled>
                <option th:each="a : ${assets}" th:text="${a.name}" th:value="${a.id}"></option>
              </select>
            </div>
            <div class="form-group dataTables_wrapper">
              <label>카테고리:</label>
              <select class="form-select displayCategory" disabled>
                <option th:each="c : ${incomeCategories}" th:text="${c.name}" th:value="${c.id}"></option>
                <option th:each="c : ${expenseCategories}" th:text="${c.name}" th:value="${c.id}"></option>
              </select>
            </div>
            <div class="form-group">
              <label>금액:</label>
              <input type="text" class="form-control displayAmountWithWon" readonly="readonly">
            </div>
            <div class="form-group">
              <label>내용:</label>
              <textarea class="form-control displayDescription" readonly="readonly"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary enableEditBtn" onclick="enableEdit()">수정</button>
            <button type="button" onclick="if (confirm('정말로 삭제하시겠습니까?')) document.deleteForm.submit();"
                    class="btn btn-secondary deleteBtn">삭제</button>
          </div>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
      </div>
    </div>

    <div id="insertModal" class="modal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" th:object="${transactionFormDto}" name="insertForm">
          <div class="modal-header">
            <h5 class="modal-title">거래 추가</h5>
            <button type="button" style="border: none;" class="btn-close"
                    onclick="$('#insertModal').modal('hide')" aria-label="Close">
              <i class="mdi mdi-window-close"></i>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" name="member" th:value="${member}" />
            <div class="form-group dataTables_wrapper">
              <label for="type">유형:</label>
              <select id="type" class="form-select" style="color: white;">
                <option value="income">수입</option>
                <option value="expense" selected>지출</option>
              </select>
            </div>
            <div class="form-group">
              <label th:for="date">날짜:</label>
              <input type="date" class="form-control" th:field="*{date}">
            </div>
            <div class="form-group dataTables_wrapper">
              <label th:for="asset">자산:</label>
              <select class="form-select" th:field="*{asset}" style="color: white;">
                <option th:each="a : ${assets}" th:text="${a.name}" th:value="${a.id}"></option>
              </select>
            </div>
            <div class="form-group dataTables_wrapper">
              <label th:for="category">카테고리:</label>
              <select class="form-select" th:field="*{category}" style="color: white;">
                <option th:each="c : ${expenseCategories}" th:text="${c.name}" th:value="${c.id}"></option>
              </select>
            </div>
            <div class="form-group">
              <label th:for="amount">금액:</label>
              <input type="text" class="form-control" th:field="*{amount}" onkeyup="inputNumberFormat(this)" style="border: 1px solid gray;">
            </div>
            <div class="form-group">
              <label th:for="description">내용:</label>
              <textarea class="form-control" th:field="*{description}"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" onclick="submitData(document.insertForm, '/transaction/insert', '등록에 성공했습니다.');" class="btn btn-primary">저장</button>
          </div>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
      </div>
    </div>

    <div id="editModal" class="modal" tabindex="-1">
      <div class="modal-dialog">
        <form class="modal-content" name="editForm">
          <div class="modal-header">
            <h5 class="modal-title">내역 수정</h5>
            <button type="button" style="border: none;" class="btn-close"
                    onclick="$('#editModal').modal('hide')" aria-label="Close">
              <i class="mdi mdi-window-close"></i>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id" class="displayId" />
            <input type="hidden" name="member" th:value="${member}" />
            <div class="form-group dataTables_wrapper">
              <label for="edit_type">유형:</label>
              <select id="edit_type" class="form-select displayType" style="color: white;">
                <option value="income">수입</option>
                <option value="expense">지출</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit_date">날짜:</label>
              <input type="date" class="form-control displayDate" name="date" id="edit_date">
            </div>
            <div class="form-group dataTables_wrapper">
              <label for="edit_asset">자산:</label>
              <select class="form-select displayAsset" name="asset" id="edit_asset" style="color: white;">
                <option th:each="a : ${assets}" th:text="${a.name}" th:value="${a.id}"></option>
              </select>
            </div>
            <div class="form-group dataTables_wrapper">
              <label for="edit_category">카테고리:</label>
              <select class="form-select displayCategory" id="edit_category" name="category" style="color: white;">
                <option th:each="c : ${incomeCategories}" th:text="${c.name}" th:value="${c.id}"></option>
                <option th:each="c : ${expenseCategories}" th:text="${c.name}" th:value="${c.id}"></option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit_amount">금액:</label>
              <input type="text" class="form-control displayAmount" name="amount" id="edit_amount"
                     onkeyup="inputNumberFormat(this)" style="border: 1px solid gray;">
            </div>
            <div class="form-group">
              <label for="edit_description">내용:</label>
              <textarea class="form-control displayDescription" name="description" id="edit_description"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" onclick="submitData(document.editForm, '/transaction/edit', '수정에 성공했습니다.');" class="btn btn-primary">수정</button>
          </div>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
      </div>
    </div>
  </div>
</body>

<th:block layout:fragment="script">
<script th:inline="javascript">
  var errorMessage = [[${errorMessage}]];
  if(errorMessage != null || errorMessage == "") alert(errorMessage);

  $(document).ready(function() {
      // 초기 데이터 로드
      loadInitialData();

      // 페이지 버튼 클릭 시 데이터 로드
      $(document).on("click", ".page-link", function(event) {
          event.preventDefault();
          var page = $(this).data("page");
          loadItems(page);
      });
  });

  function loadInitialData() {
      // 페이지 로딩 시 초기 데이터 로드
      $.ajax({
          url: "/loadItems",
          method: "GET",
          success: function(data) {
              // 성공적으로 데이터를 받아온 경우 처리
              // 예를 들어, 받아온 데이터를 테이블에 출력하는 등의 작업 수행
              renderItems(data); // 데이터를 렌더링하는 함수 호출
          },
          error: function(jqXHR, textStatus, errorThrown) {
              // 데이터를 받아오지 못한 경우 에러 처리
              console.error("Error loading initial data: " + textStatus, errorThrown);
          }
      });
  }

  function loadItems(page) {
      // 페이지 버튼 클릭 시 추가 데이터 로드
      $.ajax({
          url: "/loadItems",
          method: "GET",
          data: { page: page },
          success: function(data) {
              // 성공적으로 데이터를 받아온 경우 처리
              // 예를 들어, 받아온 데이터를 테이블에 추가하는 등의 작업 수행
              renderItems(data); // 데이터를 렌더링하는 함수 호출
          },
          error: function(jqXHR, textStatus, errorThrown) {
              // 데이터를 받아오지 못한 경우 에러 처리
              console.error("Error loading additional data: " + textStatus, errorThrown);
          }
      });
  }

  // 데이터를 테이블에 렌더링하는 함수
  function renderItems(data) {
      var tableBody = $(".table tbody");
      tableBody.empty(); // 기존 내용을 비우고 새로운 데이터를 추가할 준비

      // 받아온 데이터를 반복하여 테이블에 추가
      $.each(data.content, function(index, item) {
          var row = $("<tr></tr>");

          // 카테고리의 유형에 따라 텍스트 색상 변경
          var textColor = (item.category.type != null && item.category.type == 'INCOME') ? '#007bff' : 'red';
          row.css('color', textColor);

          // 각 열에 데이터 추가
          row.append("<td>" + formatDate(new Date(item.date)) + "</td>");
          row.append("<td>" + item.asset.name + "</td>");
          row.append("<td>" + item.category.name + "</td>");
          row.append("<td>" + item.description + "</td>");
          row.append("<td>" + item.amount.toLocaleString('ko-KR') + '원' + "</td>");

          // 클릭 시 데이터 상세정보 표시
          row.addClass("clickable-row");
          row.attr("onclick", "displayData('" + item.id + "')");

          // 테이블에 행 추가
          tableBody.append(row);
      });
  }

  // ★ 헤더에 있는 토큰 값을 가지고 온다. (반드시 같이 전송해야 함)
  var token = $("meta[name='_csrf']").attr("content");
  var header = $("meta[name='_csrf_header']").attr("content");

  // yyyy-MM-dd 형식으로 날짜를 변환하는 함수
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // 오늘 날짜를 가져오는 함수
  function getTodayDate() {
    var today = new Date();
    return formatDate(today);
  }

  // 수입과 지출 선택마다 다른 option
  $('#type, #edit_type').change(function() {
    var selectedType = $(this).val();
    var targetCategory = $(this).attr('id') === 'type' ? '#category' : '#edit_category';
    var categories = selectedType === 'income' ? [[${incomeCategories}]] : [[${expenseCategories}]];

    $(targetCategory).empty();
    $.each(categories, function(index, category) {
      $(targetCategory).append('<option value="' + category.id + '">' + category.name + '</option>');
    });
  });

  // 천단위 콤마 찍는 함수
  function inputNumberFormat(obj) {
    let value = obj.value; // 입력한 가격
    value = Number(value.replaceAll(',', '')); // 콤마를 제거

    if (isNaN(value)) {
      obj.value = 0; // 숫자가 아니면 0으로 바꾼다
    } else {
      const formatValue = value.toLocaleString('ko-KR');
      obj.value = formatValue;
    }
  }

  // insertModal 초기화
  $('#insertModal').on('hide.bs.modal', function() {
    $('#type, #asset, #category').each(function() {
      $(this).val($(this).find('option:first').val());
    });
    $('#date').val(getTodayDate());
    $('#amount, #description').val('');
  })

  // 서버에 전달할 데이터 설정
  function setParamData(form) {
    let amount = form.amount.value;
    form.amount.value = Number(amount.replaceAll(',', '')); // 콤마 제거

    return {
      id : form.id.value,
      member : form.member.value,
      date : form.date.value,
      description : form.description.value,
      amount : form.amount.value,
      asset : form.asset.value,
      category : form.category.value
    }
  }

  function submitData(form, url, successMessage) {
    const paramData = setParamData(form);

    $.ajax({
      url: url,
      type: 'POST',
      data: paramData, // 직렬화한 Form 데이터를 전송한다.
      beforeSend : function(xhr) {
        xhr.setRequestHeader(header, token);
      },
      success: function (response) {
        alert(successMessage);
        $(form).closest('.modal').modal('hide');
        location.reload();
      },
      error: function (xhr, status, error) {
        alert(xhr.responseText);
      }
    });
  }

  // 내역 조회
  function displayData(itemId) {
    $.ajax({
      url: "/transaction/view/" + itemId,
      method: "GET",
      success: function(response) {
        $('.displayId').val(response.id);
        $('.displayType').val(response.category.type == "INCOME" ? 'income' : 'expense');
        $('.displayDate').val(formatDate(new Date(response.date)));
        $('.displayAmountWithWon').val(response.amount.toLocaleString('ko-KR') + '원');
        $('.displayAmount').val(response.amount.toLocaleString('ko-KR'));
        $('.displayDescription').val(response.description);
        $('.displayAsset').val(response.asset.id);
        $('.displayCategory').val(response.category.id);

        $('#dtlModal').modal('show');
      },
      error: function(xhr, status, error) {
        alert(xhr.responseText);
      }
    });
  }

  // 수정 버튼 누르면
  function enableEdit() {
    $('#dtlModal').modal('hide');
    $('#editModal').modal('show');
  }
</script>
</th:block>

</html>